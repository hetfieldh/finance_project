{# templates/movimento/lancamento.html #}
{% extends "base.html" %}

{% block title %}Finanças | {{ title }}{% endblock %}
{% block header_title %}{{ title }}{% endblock %}

{% block content %}
<h2>Registrar Novo Lançamento Bancário</h2>

<form action="{{ url_for('movimento.mov_lancamento') }}" method="post">
    <label for="conta_id">Conta Bancária (Origem):</label>
    <select id="conta_id" name="conta_id" required>
        <option value="">Selecione a Conta</option>
        {% for conta in contas %}
        <option value="{{ conta.id }}" data-saldo="{{ conta.saldo_atual }}">{{ conta.nome_banco }} - {{
            conta.tipo_conta }} (Saldo: R$ {{ "%.2f" % conta.saldo_atual }})</option>
        {% endfor %}
    </select><br><br>

    <label for="data">Data:</label>
    <input type="date" id="data" name="data" required><br><br>

    <label for="valor">Valor do Lançamento:</label>
    <input type="text" id="valor" name="valor" step="0.01" required placeholder="Ex: 100.50 ou -50.25"><br><br>

    <label for="descricao">Tipo de Transação:</label>
    <select id="descricao" name="descricao" required>
        <option value="">Selecione a Transação</option>
        {% for transacao_item in transacoes %}
        <option value="{{ transacao_item.transacao }}" data-tipo="{{ transacao_item.tipo }}">
            {% if transacao_item.tipo == 'Entrada' %}(+){% else %}(-){% endif %} {{ transacao_item.transacao }}
        </option>
        {% endfor %}
    </select><br><br>

    <input type="checkbox" id="is_transfer" name="is_transfer" value="true">
    <label for="is_transfer">Transferência Inter Contas</label><br><br>

    <div id="target_account_group" style="display: none;">
        <label for="conta_destino_id">Conta Destino:</label>
        <select id="conta_destino_id" name="conta_destino_id">
            <option value="">Selecione a Conta Destino</option>
        </select><br><br>
    </div>

    <button type="submit" class="button">Salvar Lançamento</button>
</form>

{% endblock %}

{% block scripts_extra %}
<script>
    function today_date_js() {
        const today = new Date();
        const year = today.getFullYear();
        let month = today.getMonth() + 1;
        let day = today.getDate();

        if (day < 10) day = '0' + day;
        if (month < 10) month = '0' + month;

        return year + '-' + month + '-' + day;
    }

    document.addEventListener('DOMContentLoaded', (event) => {
        const dateInput = document.getElementById('data');
        const valorInput = document.getElementById('valor');
        const descricaoSelect = document.getElementById('descricao');
        const transacoesOptions = Array.from(descricaoSelect.options).slice(1);

        const isTransferCheckbox = document.getElementById('is_transfer');
        const targetAccountGroup = document.getElementById('target_account_group');
        const contaDestinoSelect = document.getElementById('conta_destino_id');
        const contaOrigemSelect = document.getElementById('conta_id');

        if (dateInput) {
            dateInput.value = today_date_js();
        }

        valorInput.addEventListener('input', function () {
            const valor = parseFloat(this.value.replace(',', '.'));

            if (isNaN(valor) || valor === 0) {
                transacoesOptions.forEach(option => option.style.display = '');
                descricaoSelect.value = '';
                descricaoSelect.required = true;
                return;
            }

            const tipoDesejado = valor > 0 ? 'Entrada' : 'Saída';

            transacoesOptions.forEach(option => {
                const tipoTransacao = option.dataset.tipo;
                if (tipoTransacao === tipoDesejado) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });

            if (descricaoSelect.selectedOptions[0] && descricaoSelect.selectedOptions[0].style.display === 'none') {
                descricaoSelect.value = '';
            }
            descricaoSelect.required = true;
        });

        isTransferCheckbox.addEventListener('change', function () {
            if (this.checked) {
                targetAccountGroup.style.display = 'block';
                contaDestinoSelect.required = true;
                descricaoSelect.required = false;
                descricaoSelect.value = '';
                valorInput.value = Math.abs(parseFloat(valorInput.value.replace(',', '.')) || 0);

                const transferOption = transacoesOptions.find(opt => opt.value.toLowerCase().includes('transferencia'));
                if (transferOption) {
                    descricaoSelect.value = transferOption.value;
                } else {
                    console.warn("Tipo de transação 'Transferência' não encontrado. Por favor, cadastre um.");
                }

            } else {
                targetAccountGroup.style.display = 'none';
                contaDestinoSelect.required = false;
                contaDestinoSelect.value = '';
                descricaoSelect.required = true;
            }
            filterTargetAccounts();
        });

        contaOrigemSelect.addEventListener('change', filterTargetAccounts);

        function filterTargetAccounts() {
            const selectedOriginAccountId = contaOrigemSelect.value;
            while (contaDestinoSelect.options.length > 1) {
                contaDestinoSelect.remove(1);
            }

            if (isTransferCheckbox.checked && selectedOriginAccountId) {
                const allAccountsData = JSON.parse('{{ contas | tojson | safe }}');

                allAccountsData.forEach(conta => {
                    if (String(conta.id) !== String(selectedOriginAccountId)) {
                        const option = document.createElement('option');
                        option.value = conta.id;
                        option.textContent = `${conta.nome_banco} - ${conta.tipo_conta} (Saldo: R$ ${conta.saldo_atual.toFixed(2)})`;
                        contaDestinoSelect.appendChild(option);
                    }
                });
            }
        }

        if (valorInput.value) {
            valorInput.dispatchEvent(new Event('input'));
        }

        if (isTransferCheckbox.checked) {
            filterTargetAccounts();
        }
    });
</script>
{% endblock %}