{% extends "base.html" %}

{% block title %}Finanças | {{ title }}{% endblock %}
{% block header_title %}{{ title }}{% endblock %}

{% block content %}
<h2>Editar Lançamento</h2>

<form action="{{ url_for('movimento.edit_movimento', movimento_id=movimento.id) }}" method="post">
    <label for="conta_id">Conta Bancária:</label>
    <select id="conta_id" name="conta_id" required {% if movimento.descricao=="Transferência entre contas" %}disabled{%
        endif %}> {# Desabilita se for transferência #}
        <option value="">Selecione a Conta</option>
        {% for conta in contas %}
        <option value="{{ conta.id }}" {% if conta.id==movimento.conta_id %}selected{% endif %}>
            {{ conta.nome_banco }} - {{ conta.tipo_conta }} (Saldo: R$ {{ "%.2f" % conta.saldo_atual }})
        </option>
        {% endfor %}
    </select><br><br>

    <label for="data">Data:</label>
    <input type="date" id="data" name="data" value="{{ movimento.data.strftime('%Y-%m-%d') }}" required><br><br>

    <label for="valor">Valor do Lançamento:</label>
    <input type="text" id="valor" name="valor" value="{{ " %.2f" % movimento.valor }}" step="0.01" required
        placeholder="Ex: 100.50 ou -50.25" {% if movimento.descricao=="Transferência entre contas" %}disabled{% endif
        %}> {# Desabilita o valor para transferências #}
    <br><br>

    <label for="descricao">Descrição (Tipo de Transação):</label>
    <select id="descricao" name="descricao" required {% if movimento.descricao=="Transferência entre contas"
        %}disabled{% endif %}> {# Desabilita se for transferência #}
        <option value="">Selecione a Transação</option>
        {% if transacoes %}
        {% for transacao_item in transacoes %}
        <option value="{{ transacao_item.transacao }}" data-tipo="{{ transacao_item.tipo }}" {% if
            transacao_item.transacao==movimento.descricao %}selected{% endif %}>
            {% if transacao_item.tipo == 'Entrada' %}(+){% else %}(-){% endif %} {{ transacao_item.transacao }}
        </option>
        {% endfor %}
        {% else %}
        <option value="" disabled>Nenhum tipo de transação disponível.</option>
        {% endif %}
    </select>
    {% if not transacoes %}
    <p>Por favor, <a href="{{ url_for('transacoes.list_transacoes') }}" class="button">cadastre tipos de transação</a>
        para que apareçam aqui.</p>
    {% endif %}
    <br><br>

    {# NOVO: Checkbox para Transferência Inter Contas #}
    <input type="checkbox" id="is_transfer" name="is_transfer" value="true" {% if
        movimento.descricao=="Transferência entre contas" %}checked disabled{% endif %}> {# Checked e desabilitado se
    for transferência #}
    <label for="is_transfer">Transferência Inter Contas</label><br><br>

    {# NOVO: Campo para Conta Destino (removido o estilo inline para evitar erro do linter) #}
    <div id="target_account_group">
        <label for="conta_destino_id">Conta Destino:</label>
        <select id="conta_destino_id" name="conta_destino_id" {% if movimento.descricao=="Transferência entre contas"
            %}required disabled{% endif %}> {# Desabilita se for transferência #}
            <option value="">Selecione a Conta Destino</option>
            {# Opções serão populadas dinamicamente via JavaScript ou pré-selecionadas #}
            {% for conta in contas %}
            <option value="{{ conta.id }}" {% if conta.id==transfer_counterpart_account_id %}selected{% endif %}>
                {{ conta.nome_banco }} - {{ conta.tipo_conta }} (Saldo: R$ {{ "%.2f" % conta.saldo_atual }})
            </option>
            {% endfor %}
        </select><br><br>
    </div>

    <label for="password">Confirme sua senha para editar:</label>
    <input type="password" id="password" name="password" required><br><br>

    <button type="submit" class="button">Atualizar Lançamento</button>
    <a href="{{ url_for('movimento.mov_extrato') }}" class="button cancel">Cancelar</a>
</form>
{% endblock %}

{% block scripts_extra %}
<script>
    // Passar contas para o JavaScript
    document.body.dataset.allAccounts = '{{ contas | tojson | safe }}';
    document.body.dataset.isTransferInitial = '{{ "true" if movimento.descricao == "Transferência entre contas" else "false" }}';
    document.body.dataset.transferCounterpartAccountIdInitial = '{{ transfer_counterpart_account_id if transfer_counterpart_account_id is not none else "" }}';

    document.addEventListener('DOMContentLoaded', (event) => {
        const valorInput = document.getElementById('valor');
        const descricaoSelect = document.getElementById('descricao');
        const transacoesOptions = Array.from(descricaoSelect.options).filter(option => option.value !== ""); // Ignora a primeira opção "Selecione..."

        const isTransferCheckbox = document.getElementById('is_transfer');
        const targetAccountGroup = document.getElementById('target_account_group');
        const contaDestinoSelect = document.getElementById('conta_destino_id');
        const contaOrigemSelect = document.getElementById('conta_id');

        const isTransferInitial = document.body.dataset.isTransferInitial === 'true';
        const transferCounterpartAccountIdInitial = document.body.dataset.transferCounterpartAccountIdInitial;
        const allAccountsData = JSON.parse(document.body.dataset.allAccounts);

        // Define o estado inicial de exibição do grupo de conta destino
        targetAccountGroup.style.display = isTransferInitial ? 'block' : 'none';

        // Se for uma transferência inicial, desabilita os campos relevantes
        if (isTransferInitial) {
            valorInput.disabled = true;
            descricaoSelect.disabled = true;
            contaOrigemSelect.disabled = true;
            isTransferCheckbox.disabled = true;
            contaDestinoSelect.disabled = true;
        }

        // Função para filtrar a descrição com base no valor
        function filterDescriptions() {
            // Se for uma transferência (inicial ou marcada dinamicamente), não faz o filtro dinâmico
            if (isTransferInitial || isTransferCheckbox.checked) {
                return;
            }

            const valor = parseFloat(valorInput.value.replace(',', '.'));

            if (isNaN(valor) || valor === 0) {
                transacoesOptions.forEach(option => option.style.display = '');
                descricaoSelect.value = '';
                descricaoSelect.required = true;
                return;
            }

            const tipoDesejado = valor > 0 ? 'Entrada' : 'Saída';

            let currentDescriptionMatchesType = false;
            transacoesOptions.forEach(option => {
                const tipoTransacao = option.dataset.tipo;
                if (tipoTransacao === tipoDesejado) {
                    option.style.display = '';
                    if (option.selected) {
                        currentDescriptionMatchesType = true;
                    }
                } else {
                    option.style.display = 'none';
                }
            });

            if (!currentDescriptionMatchesType && descricaoSelect.value !== "") {
                descricaoSelect.value = "";
            }
        }

        // Função para filtrar a Conta Destino com base na Conta Origem
        function filterTargetAccounts() {
            const selectedOriginAccountId = contaOrigemSelect.value;
            // Limpa as opções atuais da conta destino (exceto a primeira "Selecione...")
            while (contaDestinoSelect.options.length > 1) {
                contaDestinoSelect.remove(1);
            }

            if (isTransferCheckbox.checked && selectedOriginAccountId) {
                allAccountsData.forEach(conta => {
                    // Compara como string para garantir que a comparação de IDs seja correta (um pode ser number, outro string)
                    if (String(conta.id) !== String(selectedOriginAccountId)) {
                        const option = document.createElement('option');
                        option.value = conta.id;
                        option.textContent = `${conta.nome_banco} - ${conta.tipo_conta} (Saldo: R$ ${conta.saldo_atual.toFixed(2)})`;
                        contaDestinoSelect.appendChild(option);
                    }
                });
            }
        }

        // Adiciona listener para o campo de valor
        valorInput.addEventListener('input', filterDescriptions);

        // Adiciona listener para o checkbox de transferência
        isTransferCheckbox.addEventListener('change', function () {
            if (this.checked) {
                targetAccountGroup.style.display = 'block';
                contaDestinoSelect.required = true;
                descricaoSelect.required = false; // Descrição não é obrigatória para transferência
                descricaoSelect.value = ''; // Limpa a seleção da descrição
                valorInput.value = Math.abs(parseFloat(valorInput.value.replace(',', '.')) || 0); // Garante valor positivo para transferência
                valorInput.disabled = true; // Desabilita o valor para transferências
                descricaoSelect.disabled = true; // Desabilita a descrição para transferências
                contaOrigemSelect.disabled = false; // Habilita a conta de origem para seleção

                // Opcional: Tentar pré-selecionar uma transação de "Transferência"
                const transferOption = transacoesOptions.find(opt => opt.value.toLowerCase().includes('transferencia'));
                if (transferOption) {
                    descricaoSelect.value = transferOption.value;
                }
            } else {
                targetAccountGroup.style.display = 'none';
                contaDestinoSelect.required = false;
                contaDestinoSelect.value = ''; // Limpa a seleção da conta destino
                descricaoSelect.required = true; // Volta a ser obrigatório
                valorInput.disabled = false; // Habilita o valor
                descricaoSelect.disabled = false; // Habilita a descrição
                contaOrigemSelect.disabled = false; // Habilita a conta de origem
            }
            filterTargetAccounts(); // Atualiza as opções da conta destino
            filterDescriptions(); // Re-filtra as descrições se o valor for alterado
        });

        // Adiciona listener para a Conta Origem (para filtrar a Conta Destino)
        contaOrigemSelect.addEventListener('change', filterTargetAccounts);

        // Chama as funções ao carregar a página para inicializar o filtro e a visibilidade
        filterDescriptions();
        filterTargetAccounts(); // Garante que a conta destino esteja populada se for uma transferência inicial
    });
</script>
{% endblock %}